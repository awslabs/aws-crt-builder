name: Docker Images

on: 
  push:
    paths:
      - '.github/docker-images/*/Dockerfile'
      - '.github/workflows/docker-images.yml'
      - '*.py'

jobs:
  package:
    name: Package builder app
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v1

      # re-enable this when requirements.txt has actual dependencies
      # - name: Bundle dependencies
      #   run: |
      #     python3 -m pip install -r requirements.txt --target builder
      #     rm -rf builder/*.dist-info

      - name: Package builder
        run: |
          mkdir -p build
          python3 -m zipapp --python="/usr/bin/env python3" --output=build/builder builder

      - name: Store builder
        uses: actions/upload-artifact@v1
        with:
          name: builder
          path: build/builder

  manylinux1-x64:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: manylinux1
      IMAGE_TAG: x64

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1

    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint-manylinux.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  

  manylinux1-x86:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: manylinux1
      IMAGE_TAG: x86

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1

    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint-manylinux.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  

  manylinux2014-x64:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: manylinux2014
      IMAGE_TAG: x64

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1

    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint-manylinux.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  

  manylinux2014-x86:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: manylinux2014
      IMAGE_TAG: x86

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1

    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint-manylinux.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  
  
  Ubuntu-16-x64:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: ubuntu-16
      IMAGE_TAG: x64

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  

  AL2-x64:

    runs-on: ubuntu-latest
    needs: package
    env:
      IMAGE_NAME: al2
      IMAGE_TAG: x64

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1

    - name: Fetch builder
      uses: actions/download-artifact@v1
      with:
        name: builder
        path: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG

    - run: cp .github/docker-images/entrypoint.sh .github/docker-images/$IMAGE_NAME-$IMAGE_TAG/entrypoint.sh
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-$IMAGE_NAME
        image_tag: $IMAGE_TAG
        registry: docker.pkg.github.com
        context: .github/docker-images/$IMAGE_NAME-$IMAGE_TAG
        build_extra_args: "--compress=true"  
