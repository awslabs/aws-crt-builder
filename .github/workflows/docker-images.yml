name: Docker Images

on: 
  push:
    paths:
      - '.github/docker-images/*/Dockerfile'
      - '.github/workflows/docker-images.yml'
      - '*.py'

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Package builder
        run: |
          python3 -m pip install . --target builder_pkg
          rm -rf builder_pkg/.dist-info
          python3 -m zipapp builder_pkg --python="/usr/bin/env python3" --output=builder

  manylinux1-x64:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build manylinux1-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-manylinux1
        image_tag: x64
        registry: docker.pkg.github.com
        context: .github/docker-images/manylinux1-x64
        build_extra_args: "--compress=true"  

  manylinux1-x86:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build manylinux1-x86 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-manylinux1
        image_tag: x86
        registry: docker.pkg.github.com
        context: .github/docker-images/manylinux1-x86
        build_extra_args: "--compress=true"  

  manylinux2014-x64:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build manylinux2014-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-manylinux2014
        image_tag: x64
        registry: docker.pkg.github.com
        context: .github/docker-images/manylinux2014-x64
        build_extra_args: "--compress=true"  

  manylinux2014-x86:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build manylinux2014-x86 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-manylinux2014
        image_tag: x86
        registry: docker.pkg.github.com
        context: .github/docker-images/manylinux2014-x86
        build_extra_args: "--compress=true"  
  
  Ubuntu-16-x64:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build Ubuntu-16-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-ubuntu-16
        image_tag: x64
        registry: docker.pkg.github.com
        context: .github/docker-images/ubuntu-16-x64
        build_extra_args: "--compress=true"  

  AL2-x64:

    runs-on: ubuntu-latest
    needs: package

    steps:
    - name: Checkout Sources
      uses: actions/checkout@v1
    
    - name: Build AL2-x64 image
      uses: whoan/docker-build-with-cache-action@v3
      with:
        username: "awslabs"
        password: "${{ secrets.GITHUB_TOKEN }}"
        image_name: awslabs/aws-crt-builder/aws-crt-al2
        image_tag: x64
        registry: docker.pkg.github.com
        context: .github/docker-images/al2-x64
        build_extra_args: "--compress=true"
